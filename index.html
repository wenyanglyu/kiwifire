<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiwiFIRE S&P 500 Investment Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a2332;
            --accent: #d4af37;
            --accent-light: #f4e5b8;
            --text: #2c3e50;
            --text-light: #6c7a89;
            --card: #ffffff;
            --border: #e1e8ed;
            --success: #27ae60;
            --error: #e74c3c;
        }
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:'IBM Plex Sans',sans-serif;
            background:linear-gradient(135deg,#fafbfc 0%,#f0f4f8 100%);
            color:var(--text); line-height:1.6; min-height:100vh; padding:20px;
        }
        .container { max-width:1400px; margin:0 auto; }

        /* â”€â”€ Header â”€â”€ */
        header {
            text-align:center; margin-bottom:40px; padding:36px 20px;
            background:linear-gradient(135deg,var(--primary) 0%,#2c3e50 100%);
            border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.15);
            position:relative; overflow:hidden;
            width: 100%; /* Add this line */
            max-width: 100%; /* Add this line */
        }
        header::before {
            content:''; position:absolute; inset:0;
            background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="g" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></pattern></defs><rect width="100%25" height="100%25" fill="url(%23g)"/></svg>');
            opacity:.5;
        }
        h1 { font-family:'Playfair Display',serif; font-size:2.8em; color:#fff; margin-bottom:8px; position:relative; text-shadow:2px 2px 4px rgba(0,0,0,.2); }
        .subtitle { color:var(--accent-light); font-size:1.15em; font-weight:300; position:relative; }

        .lang-switch {
            position:absolute; top:20px; right:20px; z-index:2;
            background:rgba(255,255,255,.1); border:2px solid rgba(255,255,255,.3);
            color:#fff; padding:10px 20px; border-radius:25px;
            cursor:pointer; font-weight:600; transition:all .3s; backdrop-filter:blur(10px);
        }
        .lang-switch:hover { background:rgba(255,255,255,.2); border-color:var(--accent); transform:translateY(-2px); }

        /* â”€â”€ Layout â”€â”€ */
        .content-wrapper { display:grid; grid-template-columns:1fr 2fr; gap:28px; margin-bottom:36px; width: 100%;max-width: 100%;}

        .card {
            background:var(--card); border-radius:16px; padding:24px;
            box-shadow:0 10px 40px rgba(0,0,0,.08); border:1px solid var(--border);
            animation:fadeIn .6s ease-out;
        }
        .card h2 {
            font-family:'Playfair Display',serif; color:var(--primary);
            margin-bottom:20px; font-size:1.7em;
            border-bottom:3px solid var(--accent); padding-bottom:8px;
        }

        /* â”€â”€ Enhanced Tabs â”€â”€ */
        .tabs {
            display:flex; gap:12px; margin-bottom:24px;
        }
        .tab {
            flex:1; padding:16px 20px; background:#fff; border:3px solid var(--border);
            cursor:pointer; font-weight:700; font-size:1.05em; color:var(--text-light);
            transition:all .3s; font-family:inherit; border-radius:12px;
            text-align:center; position:relative;
        }
        .tab::before {
            content:''; position:absolute; top:0; left:0; right:0; bottom:0;
            background:linear-gradient(135deg, rgba(212,175,55,0.1), rgba(212,175,55,0.05));
            border-radius:9px; opacity:0; transition:opacity .3s;
        }
        .tab.active {
            background:linear-gradient(135deg,var(--accent),#b8941f);
            color:var(--primary); border-color:var(--accent);
            box-shadow:0 6px 20px rgba(212,175,55,.35);
            transform:translateY(-2px);
        }
        .tab.active::before { opacity:0; }
        .tab:hover:not(.active) {
            background:#f8f9fa; border-color:var(--accent);
            transform:translateY(-1px);
        }
        .tab:hover:not(.active)::before { opacity:1; }

        .tab-content { display:none; }
        .tab-content.active { display:block; }

        /* â”€â”€ Inputs â”€â”€ */
        .input-group { margin-bottom:14px; }
        .input-group label { display:block; margin-bottom:5px; font-weight:600; color:var(--text); font-size:.9em; }
        .bilingual-label { display:flex; justify-content:space-between; }
        .input-note { font-size:.8em; color:var(--text-light); margin-top:3px; font-style:italic; }
        .input-explanation {
            font-size:.85em; color:var(--text-light); margin-top:0px; margin-bottom:14px;
            padding:10px 12px; background:rgba(212,175,55,.08);
            border-radius:6px; border-left:3px solid var(--accent);
        }

        input, select {
            width:100%; padding:10px 14px; border:2px solid var(--border);
            border-radius:8px; font-size:1em; font-family:'IBM Plex Sans',sans-serif;
            transition:all .3s; background:#fff;
        }
        input:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(212,175,55,.1); }

        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .input-section {
            background:linear-gradient(135deg,#f8f9fa,#e9ecef);
            padding:16px; border-radius:12px; margin-bottom:16px;
            border-left:4px solid var(--accent);
        }
        .section-title {
            font-weight:700; color:var(--primary); font-size:1.05em;
            margin-bottom:12px; display:flex; align-items:center; gap:8px;
        }
        .section-title::before {
            content:''; width:6px; height:6px; border-radius:50%;
            background:var(--accent);
        }

        /* â”€â”€ DCA Periods â”€â”€ */
        .period-zone {
            padding:12px 0; margin-bottom:12px;
            border-bottom:1px solid var(--border);
        }
        .period-zone.first-period {
            padding-top:0;
        }
        .period-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .period-title { font-weight:600; color:var(--primary); font-size:1.02em; }
        .remove-period {
            background:var(--error); color:#fff; border:none;
            padding:5px 10px; border-radius:6px; cursor:pointer; font-size:.82em; transition:all .3s;
        }
        .remove-period:hover { background:#c0392b; transform:scale(1.05); }
        .period-inputs { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

        /* â”€â”€ Pension Zone â”€â”€ */
        .pension-zone {
            padding:12px 0; margin-bottom:12px;
            border-bottom:1px solid var(--border);
        }
        .pension-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .pension-title { font-weight:600; color:var(--primary); font-size:1.02em; }
        .pension-inputs { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

        .rebalance-block {
            padding-bottom:16px; margin-bottom:16px; border-bottom:2px dashed var(--border);
        }
        .rebalance-block:last-child {
            border-bottom:none; padding-bottom:0; margin-bottom:0;
        }

        /* â”€â”€ Buttons â”€â”€ */
        .btn { padding:12px 22px; border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer; transition:all .3s; font-family:inherit; }
        .btn-primary { background:linear-gradient(135deg,var(--accent),#b8941f); color:var(--primary); box-shadow:0 4px 15px rgba(212,175,55,.3); }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(212,175,55,.4); }
        .btn-secondary { background:#fff; color:var(--text); border:2px solid var(--border); }
        .btn-secondary:hover { border-color:var(--accent); background:var(--accent-light); }
        .button-group { display:flex; gap:12px; margin-top:16px; }

        /* â”€â”€ Chart â”€â”€ */
        .chart-container { position:relative; height:500px; margin-top:18px; }

        /* â”€â”€ Stats â”€â”€ */
        .result-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:18px; }
        .stat-card {
            background:linear-gradient(135deg,var(--primary),#2c3e50);
            padding:15px 8px; border-radius:12px; color:#fff; text-align:center;
        }
        .stat-card.danger { background:linear-gradient(135deg,#922b21,#c0392b); }
        .stat-label { font-size:.8em; opacity:.85; margin-bottom:5px; line-height:1.3; }
        .stat-value { font-size:1.5em; font-weight:700; color:var(--accent-light); }
        .stat-card.danger .stat-value { color:#f5b7b1; }

        /* â”€â”€ Assumptions â”€â”€ */
        .assumptions {
            background:linear-gradient(135deg,#fff9e6,#fffbf0);
            border-left:5px solid var(--accent); padding:22px;
            border-radius:12px; margin-top:28px;
        }
        .assumptions h3 { color:var(--primary); margin-bottom:14px; font-family:'Playfair Display',serif; font-size:1.45em; }
        .assumptions ul { list-style:none; padding-left:0; }
        .assumptions li { padding:6px 0; padding-left:23px; position:relative; }
        .assumptions li::before { content:'â†’'; position:absolute; left:0; color:var(--accent); font-weight:bold; }
        .section-divider { margin:14px 0; padding-top:14px; border-top:1px solid rgba(0,0,0,.1); }

        .loading { display:none; text-align:center; padding:20px; color:var(--text-light); }
        .loading.active { display:block; }

        @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

        /* â”€â”€ Responsive â”€â”€ */
        @media(max-width:1024px){
            .content-wrapper{grid-template-columns:1fr}
            h1{font-size:2em}
            .result-stats{grid-template-columns:repeat(4,1fr)}
            .input-row{grid-template-columns:1fr}
        }
        @media(max-width:768px){
            body{padding:10px}
            header{padding:26px 14px;margin-bottom:20px;width:100%; max-width: 100%;}
            h1{font-size:1.5em}
            .subtitle{font-size:.92em}
            .lang-switch{top:12px;right:12px;padding:7px 14px;font-size:.84em}
            .card{padding:14px}
            .card h2{font-size:1.25em;margin-bottom:12px}
            .input-group{margin-bottom:10px}
            .period-zone{padding:12px;margin-bottom:10px}
            .period-inputs{grid-template-columns:1fr;gap:6px}
            .result-stats{grid-template-columns:1fr 1fr;gap:9px}
            .stat-card{padding:11px 6px}
            .stat-value{font-size:1.25em}
            .stat-label{font-size:.76em}
            .chart-container{height:330px}
            .button-group{flex-direction:column;margin-top:12px}
            .btn{width:100%}
            .assumptions{padding:14px}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="lang-switch" onclick="toggleLanguage()">
                <span class="lang-en">ä¸­æ–‡</span>
                <span class="lang-zh" style="display:none">English</span>
            </button>
            <h1>
                <span class="lang-en">Kiwi FIRE Simulator</span>
                <span class="lang-zh" style="display:none">Kiwi Fire æ¨¡æ‹Ÿå™¨</span>
            </h1>
            <p class="subtitle">
                <span class="lang-en">S&P 500â€“Based Financial Independence & Early Retirement Plan</span>
                <span class="lang-zh" style="display:none">åŸºäºæ ‡æ™®500å®šæŠ•çš„è´¢åŠ¡ç‹¬ç«‹ä¸æå‰é€€ä¼‘è§„åˆ’</span>
            </p>
        </header>

        <div class="content-wrapper">
            <!-- Left: Inputs -->
            <div class="card">
                <h2>
                    <span class="lang-en">Parameters</span>
                    <span class="lang-zh" style="display:none">å‚æ•°è®¾ç½®</span>
                </h2>

                <!-- Retirement Target Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTargetMode('amount')">
                        <span class="lang-en">Target Amount</span>
                        <span class="lang-zh" style="display:none">ç›®æ ‡é‡‘é¢</span>
                    </button>
                    <button class="tab" onclick="switchTargetMode('year')">
                        <span class="lang-en">Target Year</span>
                        <span class="lang-zh" style="display:none">ç›®æ ‡å¹´ä»½</span>
                    </button>
                </div>

                <!-- Target Amount Tab -->
                <div id="targetAmountTab" class="tab-content active">
                    <div class="input-group">
                        <label class="bilingual-label">
                            <span class="lang-en">Wealth Target Before You Retire($)</span>
                            <span class="lang-zh" style="display:none">é€€ä¼‘ç›®æ ‡é‡‘é¢ ($)</span>
                        </label>
                        <input type="text" id="retirementTarget" value="2,000,000" onblur="formatNumber(this)">
                    </div>
                </div>

                <!-- Target Year Tab -->
                <div id="targetYearTab" class="tab-content">
                    <div class="input-group">
                        <label class="bilingual-label">
                            <span class="lang-en">Target Year You Want To Retire</span>
                            <span class="lang-zh" style="display:none">ç›®æ ‡é€€ä¼‘å¹´ä»½</span>
                        </label>
                        <input type="number" id="targetRetirementYear" value="2036" step="1">
                    </div>
                </div>

                <!-- Post-Retirement Tab -->
                <div id="postRetireTab" class="tab-content">
                    <div class="input-section" style="background:linear-gradient(135deg,#fff,#f8f9fa); padding:16px; border-radius:12px; margin-bottom:16px; border-left:4px solid var(--accent);">
                        <div class="section-title" style="font-weight:700; color:var(--primary); font-size:1.05em; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                            <span class="lang-en">Post-Retirement Parameters</span>
                            <span class="lang-zh" style="display:none">é€€ä¼‘åå‚æ•°</span>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label class="bilingual-label">
                                    <span class="lang-en">Bond Return (%)</span>
                                    <span class="lang-zh" style="display:none">å€ºåˆ¸å¹´åŒ–æ”¶ç›Š (%)</span>
                                </label>
                                <input type="number" id="postBondReturn2" value="4.0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- S&P 500 Investment -->
                <div class="input-section">
                    <div class="section-title">
                        <span class="lang-en">S&P 500 Investment</span>
                        <span class="lang-zh" style="display:none">æ ‡æ™®500æŠ•èµ„</span>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Initial Investment ($)</span>
                                <span class="lang-zh" style="display:none">åˆå§‹æŠ•èµ„ ($)</span>
                            </label>
                            <input type="text" id="initialInv" value="100,000" onblur="formatNumber(this)">
                        </div>
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Invest Year</span>
                                <span class="lang-zh" style="display:none">åˆå§‹å¹´ä»½</span>
                            </label>
                            <input type="number" id="startYear" value="2026" step="1">
                        </div>
                    </div>

                    <!-- DCA Period 1 (First Period) -->
                    <div id="firstPeriodContainer"></div>

                    <!-- Additional DCA Periods -->
                    <div id="periodsContainer"></div>
                    <button class="btn btn-secondary" onclick="addPeriod()" style="width:100%; margin-top:8px">
                        <span class="lang-en">+ Add DCA Period</span>
                        <span class="lang-zh" style="display:none">+ æ·»åŠ å®šæŠ•æœŸ</span>
                    </button>
                </div>

                <!-- Post-Retirement Settings -->
                <div class="input-section">
                    <div class="section-title">
                        <span class="lang-en">Post-Retirement Settings</span>
                        <span class="lang-zh" style="display:none">é€€ä¼‘åè®¾ç½®</span>
                    </div>

                    <div class="input-explanation">
                        <span class="lang-en">ğŸ’¡ In today's dollars - will be adjusted for inflation</span>
                        <span class="lang-zh" style="display:none">ğŸ’¡ ä»¥ä»Šæ—¥ä»·å€¼è®¡ç®— - æ¯å¹´æ ¹æ®é€šèƒ€è‡ªåŠ¨è°ƒæ•´</span>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Annual Living Cost ($)</span>
                                <span class="lang-zh" style="display:none">å¹´ç”Ÿæ´»æˆæœ¬ ($)</span>
                            </label>
                            <input type="text" id="livingCost" value="80,000" onblur="formatNumber(this)">
                        </div>
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Inflation Rate (%)</span>
                                <span class="lang-zh" style="display:none">é€šè´§è†¨èƒ€ç‡ (%)</span>
                            </label>
                            <input type="number" id="inflation" value="3" step="0.1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Buffer Years</span>
                                <span class="lang-zh" style="display:none">ç°é‡‘ç¼“å†²å¹´æ•°</span>
                            </label>
                            <input type="number" id="bufferYears" value="3" min="0" max="10" step="1">
                        </div>

                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Bond Return (%)</span>
                                <span class="lang-zh" style="display:none">å€ºåˆ¸å¹´åŒ–æ”¶ç›Š (%)</span>
                            </label>
                            <input type="number" id="postBondReturn" value="4.0" step="0.1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Simulation Times</span>
                                <span class="lang-zh" style="display:none">æ¨¡æ‹Ÿæ¬¡æ•°</span>
                            </label>
                            <input type="number" id="simulationTimes" value="10000" min="1000" max="100000" step="1000">
                        </div>
                        <div class="input-group">
                            <label class="bilingual-label">
                                <span class="lang-en">Life Expectancy</span>
                                <span class="lang-zh" style="display:none">é¢„æœŸå¯¿å‘½</span>
                            </label>
                            <input type="number" id="lifeExpectancy" value="2096" min="2046" max="2126" step="1">
                        </div>
                    </div>

                    <!-- Pension Period -->
                    <div class="pension-zone">
                        <div class="pension-header">
                            <div class="pension-title">
                                <span class="lang-en">Pension (until death)</span>
                                <span class="lang-zh" style="display:none">å…»è€é‡‘ï¼ˆç›´åˆ°å»ä¸–ï¼‰</span>
                            </div>
                        </div>
                        <div class="pension-inputs" style="grid-template-columns:1fr 1fr;">
                            <div class="input-group" style="margin-bottom:0">
                                <label>
                                    <span class="lang-en">Start Year</span>
                                    <span class="lang-zh" style="display:none">èµ·å§‹å¹´</span>
                                </label>
                                <input type="number" id="pensionStartYear" value="2066" step="1">
                            </div>
                            <div class="input-group" style="margin-bottom:0">
                                <label>
                                    <span class="lang-en">Annual ($)</span>
                                    <span class="lang-zh" style="display:none">å¹´é‡‘é¢ ($)</span>
                                </label>
                                <input type="number" id="pensionAnnual" value="43056" step="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="button-group">
                    <button class="btn btn-primary" onclick="calculate()" style="flex:1">
                        <span class="lang-en">Simulate</span>
                        <span class="lang-zh" style="display:none">æ¨¡æ‹Ÿ</span>
                    </button>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="card">
                <h2>
                    <span class="lang-en">Single Simulation Results</span>
                    <span class="lang-zh" style="display:none">å•æ¬¡æ¨¡æ‹Ÿç»“æœ</span>
                </h2>
                <div id="statsContainer" class="result-stats"></div>
                
                <!-- Log Scale Toggle -->
                <div style="margin-top:16px; margin-bottom:8px; display:flex; align-items:center; gap:12px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.9em; color:var(--text);">
                        <input type="checkbox" id="logScaleToggle" onchange="toggleLogScale()" style="width:auto; cursor:pointer;">
                        <span class="lang-en">Logarithmic Scale</span>
                        <span class="lang-zh" style="display:none">å¯¹æ•°åˆ»åº¦</span>
                    </label>
                    <span style="font-size:0.8em; color:var(--text-light); font-style:italic;">
                        <span class="lang-en">(Better for visualizing early years when final wealth is very large)</span>
                        <span class="lang-zh" style="display:none">(å½“æœ€ç»ˆè´¢å¯Œå¾ˆå¤§æ—¶ï¼Œæ›´å¥½åœ°æ˜¾ç¤ºæ—©æœŸå¹´ä»½)</span>
                    </span>
                </div>
                
                <div class="chart-container">
                    <canvas id="wealthChart"></canvas>
                </div>
                
                <!-- 10000 Simulations Summary -->
                <div id="simulationSummary" style="margin-top:48px; display:none;">
                    <h3 style="font-family:'Playfair Display',serif; color:var(--primary); margin-bottom:24px; font-size:1.5em; border-bottom:2px solid var(--accent); padding-bottom:12px;">
                        <span class="lang-en">10000 Simulations Summary</span>
                        <span class="lang-zh" style="display:none">10000æ¬¡æ¨¡æ‹Ÿæ±‡æ€»ç»“æœ</span>
                    </h3>
                    <div id="summaryStatsContainer" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:24px;"></div>
                </div>
            </div>
        </div>

        <!-- Assumptions -->
        <div class="card assumptions">
            <h3>
                <span class="lang-en">Key Assumptions</span>
                <span class="lang-zh" style="display:none">å…³é”®å‡è®¾</span>
            </h3>
            <ul>
                <li><span class="lang-en">Uses historical S&P 500 returns (1926-2025) randomly for simulation</span>
                    <span class="lang-zh" style="display:none">ä½¿ç”¨æ ‡æ™®500å†å²æ”¶ç›Šç‡ï¼ˆ1926-2025ï¼‰éšæœºæ¨¡æ‹Ÿ</span></li>
                <li><span class="lang-en">Before retirement: living costs covered by income (not modeled)</span>
                    <span class="lang-zh" style="display:none">é€€ä¼‘å‰ï¼šç”Ÿæ´»æˆæœ¬ç”±æ”¶å…¥è¦†ç›–ï¼ˆä¸è®¡å…¥æ¨¡å‹ï¼‰</span></li>
                <li><span class="lang-en">Annual Living Cost and Pension Income use today's dollar, will be adjusted with inflation</span>
                    <span class="lang-zh" style="display:none">æ¯å¹´ç”Ÿæ´»è´¹å’Œå…»è€é‡‘æ”¶å…¥ä½¿ç”¨å½“å‰å€¼ï¼Œéšç€å¹´ä»½ä¼šè‡ªåŠ¨æ ¹æ®é€šèƒ€è°ƒæ•´</span></li>
                <li><span class="lang-en">Year 2 of retirement: transfer (buffer years Ã— living cost) from equity to bonds</span>
                    <span class="lang-zh" style="display:none">é€€ä¼‘ç¬¬äºŒå¹´ï¼šä»è‚¡ç¥¨è½¬ç§»ï¼ˆç¼“å†²å¹´æ•° Ã— ç”Ÿæ´»æˆæœ¬ï¼‰è‡³å€ºåˆ¸</span></li>
                <li><span class="lang-en">After retirement withdrawal: â‘  Harvest equity gains firstâ†’ â‘¡ Pay living cost (pension reduces cost) â†’ â‘¢ Maintain bond buffer (buffer years Ã— living cost), excess back to equity â†’ â‘£ When equity below principal, use bonds for living cost â†’ â‘¤ When bonds depleted, withdraw from equity principal</span>
                    <span class="lang-zh" style="display:none">é€€ä¼‘åæå–ç­–ç•¥ï¼šâ‘  ä¼˜å…ˆæ”¶å‰²è‚¡ç¥¨æ”¶ç›Š â†’ â‘¡ æ”¯ä»˜ç”Ÿæ´»è´¹ï¼ˆå…»è€é‡‘å¯æŠµæ‰£ï¼‰ â†’ â‘¢ å€ºåˆ¸ä¿æŒï¼ˆç¼“å†²å¹´æ•° Ã— ç”Ÿæ´»æˆæœ¬ï¼‰ï¼Œè¶…é¢å›è‚¡ç¥¨ â†’ â‘£ è‚¡ç¥¨ä½äºæœ¬é‡‘æ—¶ä½¿ç”¨å€ºåˆ¸æ”¯ä»˜ç”Ÿæ´»è´¹ â†’ â‘¤ å€ºåˆ¸è€—å°½æ—¶ä»è‚¡ç¥¨æœ¬é‡‘æå–</span></li>
                <div class="section-divider"></div>
                <li><span class="lang-en">The interpretation rights of this simulator belong to Rednote ç¾Šæ‘å­¦é•¿.</span>
                    <span class="lang-zh" style="display:none">æœ¬ç½‘é¡µæ¨¡æ‹Ÿå™¨çš„æœ€ç»ˆè§£é‡Šæƒå½’å°çº¢ä¹¦ç¾Šæ‘å­¦é•¿æ‰€æœ‰</span></li>
            </ul>
        </div>
    </div>

<script>
let currentLang = 'zh';
let chartInstance = null;
let periods = [];
let targetMode = 'amount';
let chartLogScale = true; // Default to logarithmic scale
let lastSimulationData = null; // Store last simulation data for re-rendering

// Historical S&P 500 returns (1926-2025)
const sp500Returns = [
    0.1788, 0.2502, 0.2629, -0.1811, 0.2871, 0.1840, 0.3149, -0.0438, 0.2183, 0.1196,
    0.0138, 0.1369, 0.3239, 0.1600, 0.0211, 0.1506, 0.2646, -0.3700, 0.0549, 0.1579,
    0.0491, 0.1088, 0.2868, -0.2210, -0.1189, -0.0910, 0.2104, 0.2858, 0.3336, 0.2296,
    0.3758, 0.0132, 0.1008, 0.0762, 0.3047, -0.0310, 0.3169, 0.1661, 0.0525, 0.1867,
    0.3173, 0.0627, 0.2256, 0.2155, -0.0491, 0.3242, 0.1844, 0.0656, -0.0718, 0.2384,
    0.3720, -0.2647, -0.1466, 0.1898, 0.1431, 0.0401, -0.0850, 0.1106, 0.2398, -0.1006,
    0.1245, 0.1648, 0.2280, -0.0873, 0.2689, 0.0047, 0.1196, 0.4336, -0.1078, 0.0656,
    0.3156, 0.5262, -0.0099, 0.1837, 0.2402, 0.3171, 0.1879, 0.0550, 0.0571, -0.0807,
    0.3644, 0.1975, 0.2590, 0.2034, -0.1159, -0.0978, -0.0041, 0.3112, -0.3503, 0.3392,
    0.4767, -0.0144, 0.5399, -0.0819, -0.4334, -0.2490, -0.0842, 0.4361, 0.3749, 0.1162
];

/* â”€â”€â”€ Initialize â”€â”€â”€ */
window.onload = function(){
    addFirstPeriod();

    // Apply default language to all static elements
    document.querySelectorAll('.lang-en').forEach(e=> e.style.display = 'none');
    document.querySelectorAll('.lang-zh').forEach(e=> e.style.display = 'inline');

    // Add event listener for target year changes
    document.getElementById('targetRetirementYear').addEventListener('input', function(){
        if (targetMode === 'year') {
            syncDCAEndYearWithTargetYear();
        }
    });
    
    // Add event listener for invest year changes - sync to DCA Period 1 start
    document.getElementById('startYear').addEventListener('input', function(){
        const firstPeriod = document.getElementById('first_period');
        if (firstPeriod) {
            const startYearInput = firstPeriod.querySelector('.p-start');
            if (startYearInput) {
                startYearInput.value = this.value;
            }
        }
    });
};

function formatNumber(input) {
    let value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value !== '') {
        input.value = parseFloat(value).toLocaleString('en-US');
    }
}

function parseFormattedNumber(value) {
    return parseFloat(value.replace(/,/g, ''));
}

function switchTargetMode(mode) {
    targetMode = mode;
    
    const tabs = document.querySelectorAll('.tabs .tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('targetAmountTab').classList.remove('active');
    document.getElementById('targetYearTab').classList.remove('active');
    document.getElementById('postRetireTab').classList.remove('active');

    if (mode === 'amount') {
        document.getElementById('targetAmountTab').classList.add('active');
    } else if (mode === 'year') {
        document.getElementById('targetYearTab').classList.add('active');
        // Sync DCA Period 1 end year with target year
        syncDCAEndYearWithTargetYear();
    } else if (mode === 'postretire') {
        document.getElementById('postRetireTab').classList.add('active');
    }
}

function syncDCAEndYearWithTargetYear() {
    const targetYear = parseInt(document.getElementById('targetRetirementYear').value);
    const firstPeriod = document.getElementById('first_period');
    if (firstPeriod && targetYear) {
        const endYearInput = firstPeriod.querySelector('.p-end');
        if (endYearInput) {
            endYearInput.value = targetYear;
        }
    }
}

/* â”€â”€â”€ DCA Periods â”€â”€â”€ */
function addFirstPeriod(){
    const container = document.getElementById('firstPeriodContainer');
    const div = document.createElement('div');
    div.className = 'period-zone first-period';
    div.id = 'first_period';
    div.innerHTML = `
        <div class="period-header">
            <div class="period-title">
                <span class="lang-en">DCA Period 1</span>
                <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">å®šæŠ•æœŸ 1</span>
            </div>
        </div>
        <div class="period-inputs">
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">Start Year</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">èµ·å§‹å¹´</span>
                </label>
                <input type="number" class="p-start" value="2026" step="1">
            </div>
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">End Year</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">ç»“æŸå¹´</span>
                </label>
                <input type="number" class="p-end" value="2036" step="1">
            </div>
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">Annual ($)</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">å¹´æŠ•å…¥ ($)</span>
                </label>
                <input type="text" class="p-amt" value="50,000" onblur="formatNumber(this)">
            </div>
        </div>
    `;
    container.appendChild(div);
}

function addPeriod(){
    const id = Date.now();
    periods.push(id);
    const container = document.getElementById('periodsContainer');
    
    const div = document.createElement('div');
    div.className = 'period-zone';
    div.id = `period_${id}`;
    div.innerHTML = `
        <div class="period-header">
            <div class="period-title">
                <span class="lang-en">DCA Period ${periods.length + 1}</span>
                <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">å®šæŠ•æœŸ ${periods.length + 1}</span>
            </div>
            <button class="remove-period" onclick="removePeriod(${id})">
                <span class="lang-en">Remove</span>
                <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">åˆ é™¤</span>
            </button>
        </div>
        <div class="period-inputs">
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">Start Year</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">èµ·å§‹å¹´</span>
                </label>
                <input type="number" class="p-start" value="${2025 + periods.length}" step="1">
            </div>
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">End Year</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">ç»“æŸå¹´</span>
                </label>
                <input type="number" class="p-end" value="${2030 + periods.length}" step="1">
            </div>
            <div class="input-group" style="margin-bottom:0">
                <label>
                    <span class="lang-en">Annual ($)</span>
                    <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">å¹´æŠ•å…¥ ($)</span>
                </label>
                <input type="text" class="p-amt" value="30,000" onblur="formatNumber(this)">
            </div>
        </div>
    `;
    container.appendChild(div);
}

function removePeriod(id){
    const idx = periods.indexOf(id);
    if(idx > -1) periods.splice(idx, 1);
    document.getElementById(`period_${id}`).remove();
    
    document.querySelectorAll('#periodsContainer .period-zone').forEach((zone, i) => {
        const title = zone.querySelector('.period-title');
        title.innerHTML = `
            <span class="lang-en">DCA Period ${i + 2}</span>
            <span class="lang-zh" style="display:${currentLang==='zh'?'inline':'none'}">å®šæŠ•æœŸ ${i + 2}</span>
        `;
    });
}

/* â”€â”€â”€ Random Return Generator â”€â”€â”€ */
function getRandomReturnsSequence(length) {
    const sequence = [];
    const availableIndices = [...Array(sp500Returns.length).keys()];
    
    for (let i = 0; i < length; i++) {
        if (availableIndices.length === 0) {
            // If we've used all years, reset the pool
            availableIndices.push(...Array(sp500Returns.length).keys());
        }
        const randomIndex = Math.floor(Math.random() * availableIndices.length);
        const yearIndex = availableIndices.splice(randomIndex, 1)[0];
        sequence.push(sp500Returns[yearIndex]);
    }
    
    return sequence;
}

/* â”€â”€â”€ Calculate â”€â”€â”€ */
function calculate(){
    // Get inputs
    const startYear = parseInt(document.getElementById('startYear').value);
    const initialInv = parseFormattedNumber(document.getElementById('initialInv').value);
    const inflation = parseFloat(document.getElementById('inflation').value) / 100;
    const livingCostToday = parseFormattedNumber(document.getElementById('livingCost').value);
    const bufferYears = parseFloat(document.getElementById('bufferYears').value);

    // Post-retirement settings
    const postBondReturn = parseFloat(document.getElementById('postBondReturn').value) / 100;
    const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);

    // Pension inputs
    const pensionStartYear = parseInt(document.getElementById('pensionStartYear').value);
    const pensionAnnual = parseFormattedNumber(document.getElementById('pensionAnnual').value);

    // Get retirement target
    let retTarget, targetYear;
    if (targetMode === 'amount') {
        retTarget = parseFormattedNumber(document.getElementById('retirementTarget').value);
        targetYear = null;
    } else {
        targetYear = parseInt(document.getElementById('targetRetirementYear').value);
        retTarget = null;
    }

    // Get DCA periods
    const dcaPeriods = [];
    const firstPeriod = document.getElementById('first_period');
    const s1 = parseInt(firstPeriod.querySelector('.p-start').value);
    const e1 = parseInt(firstPeriod.querySelector('.p-end').value);
    const a1 = parseFormattedNumber(firstPeriod.querySelector('.p-amt').value);
    if(!isNaN(s1) && !isNaN(e1) && !isNaN(a1) && s1 <= e1){
        dcaPeriods.push({start:s1, end:e1, amount:a1});
    }

    document.querySelectorAll('#periodsContainer .period-zone').forEach(zone => {
        const s = parseInt(zone.querySelector('.p-start').value);
        const e = parseInt(zone.querySelector('.p-end').value);
        const a = parseFormattedNumber(zone.querySelector('.p-amt').value);
        if(!isNaN(s) && !isNaN(e) && !isNaN(a) && s <= e){
            dcaPeriods.push({start:s, end:e, amount:a});
        }
    });

    if(dcaPeriods.length === 0){
        alert(currentLang==='en' ? 'Please add at least one investment period.' : 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæŠ•èµ„æœŸã€‚');
        return;
    }

    // Get simulation times
    const simulationTimes = parseInt(document.getElementById('simulationTimes').value) || 100;

    // Run N simulations
    const simResults = [];
    for (let sim = 0; sim < simulationTimes; sim++) {
        const result = runSingleSimulation(
            startYear, initialInv, inflation, livingCostToday, bufferYears,
            postBondReturn, pensionStartYear, pensionAnnual,
            retTarget, targetYear, dcaPeriods, lifeExpectancy
        );
        simResults.push(result);
    }

    // Use first simulation for detailed display
    const mainResult = simResults[0];
    
    // Store for log scale toggle
    lastSimulationData = {
        data: mainResult.data,
        retireYear: mainResult.retireYear,
        dieYear: mainResult.dieYear,
        retTarget: mainResult.retTarget,
        totalInvested: mainResult.totalInvested,
        lcAtRetire: mainResult.lcAtRetire,
        startYear: startYear
    };
    
    renderResults(
        mainResult.data, 
        mainResult.retireYear, 
        mainResult.dieYear, 
        mainResult.retTarget, 
        mainResult.totalInvested, 
        mainResult.lcAtRetire, 
        startYear
    );
    
    // Update DCA Period 1 end year to retirement year in Target Amount mode
    if (targetMode === 'amount' && mainResult.retireYear) {
        const firstPeriod = document.getElementById('first_period');
        if (firstPeriod) {
            const endYearInput = firstPeriod.querySelector('.p-end');
            if (endYearInput) {
                endYearInput.value = mainResult.retireYear;
            }
        }
    }
    
    // Render 100-simulation summary
    renderSimulationSummary(simResults, startYear);
}

/* â”€â”€â”€ Toggle Log Scale â”€â”€â”€ */
function toggleLogScale() {
    chartLogScale = document.getElementById('logScaleToggle').checked;
    window.chartLogScale = chartLogScale;
    
    // Re-render chart with stored data
    if (lastSimulationData) {
        renderResults(
            lastSimulationData.data,
            lastSimulationData.retireYear,
            lastSimulationData.dieYear,
            lastSimulationData.retTarget,
            lastSimulationData.totalInvested,
            lastSimulationData.lcAtRetire,
            lastSimulationData.startYear
        );
    }
}

/* â”€â”€â”€ Run Single Simulation â”€â”€â”€ */
function runSingleSimulation(
    startYear, initialInv, inflation, livingCostToday, bufferYears,
    postBondReturn, pensionStartYear, pensionAnnual,
    retTarget, targetYear, dcaPeriods, lifeExpectancy
) {
    const data = [];
    let equityValue = initialInv;
    let equityPrincipal = initialInv;
    let bondValue = 0;
    let totalInvested = initialInv;
    let retireYear = null;
    let dieYear = null;
    let lcAtRetire = 0;
    let currentBondReturn = postBondReturn;

    const maxPeriodEnd = Math.max(...dcaPeriods.map(p => p.end));
    const maxYear = lifeExpectancy;
    
    // Get random returns sequence (no repeats until all years used)
    const returnsSequence = getRandomReturnsSequence(maxYear - startYear + 1);
    let returnIndex = 0;

    for(let year = startYear; year <= maxYear; year++){
        const isRetired = retireYear !== null && year >= retireYear;

        // Apply buffer transfer in year 2 of retirement (yearsAfterRetire === 1)
        if (retireYear !== null && year - retireYear === 1) {
            const bufferAmount = bufferYears * lcAtRetire;
            const transferAmount = Math.min(bufferAmount, equityValue);
            equityValue -= transferAmount;
            bondValue += transferAmount;
            equityPrincipal = equityValue; // Reset principal after transfer
        }

        if(!isRetired){
            // Accumulation phase
            let annualContribution = 0;
            for(const p of dcaPeriods){
                if(year >= p.start && year <= p.end){
                    annualContribution += p.amount;
                }
            }
            
            equityValue += annualContribution;
            equityPrincipal += annualContribution;
            totalInvested += annualContribution;

            // Apply returns
            const eqReturn = returnsSequence[returnIndex++];
            equityValue *= (1 + eqReturn);
            bondValue *= (1 + currentBondReturn);

            const totalWealth = equityValue + bondValue;

            // Check retirement condition
            if (targetMode === 'amount') {
                if (totalWealth >= retTarget && retireYear === null) {
                    retireYear = year;
                    const yearsFromNow = retireYear - startYear;
                    lcAtRetire = livingCostToday * Math.pow(1 + inflation, yearsFromNow);
                }
            } else {
                if (year === targetYear) {
                    retireYear = year;
                    retTarget = totalWealth;
                    const yearsFromNow = retireYear - startYear;
                    lcAtRetire = livingCostToday * Math.pow(1 + inflation, yearsFromNow);
                }
            }

            data.push({
                year,
                equity: equityValue,
                bond: bondValue,
                totalWealth,
                livingCost: 0,
                phase: 'accumulation'
            });
        } else {
            // Retirement phase - CORRECTED ORDER
            
            // 1. Recalculate living cost
            const yearsAfterRetire = year - retireYear;
            let livingCostThisYear = lcAtRetire * Math.pow(1 + inflation, yearsAfterRetire);
            
            // 1b. Apply pension income if in pension period (continues until death)
            if (year >= pensionStartYear) {
                const pensionThisYear = pensionAnnual * Math.pow(1 + inflation, year - startYear);
                livingCostThisYear = Math.max(0, livingCostThisYear - pensionThisYear);
            }
            
            // 2. Calculate bond max buffer
            const bondMax = bufferYears * livingCostThisYear;
            
            // 3. Harvest equity excess above principal
            const takeFromEquity1 = Math.max(0, equityValue - equityPrincipal);
            equityValue = equityValue - takeFromEquity1;
            
            // 4. Use harvested equity to pay living cost
            const bondChange = takeFromEquity1 - livingCostThisYear;
            bondValue = bondValue + bondChange;
            
            // 5. If bond buffer exceeds maximum, rebalance back to equity
            if (bondValue > bondMax) {
                const putBackEquity1 = bondValue - bondMax;
                equityValue = equityValue + putBackEquity1;
                equityPrincipal = equityPrincipal + putBackEquity1; // Increase principal
                bondValue = bondMax;
            }
            
            // 6. If bonds are insufficient, draw remainder from equity
            if (bondValue < 0) {
                const takeFromEquity2 = -bondValue;
                bondValue = 0;
                equityValue = equityValue - takeFromEquity2;
                equityPrincipal = Math.max(0, equityPrincipal - takeFromEquity2); // Reduce principal
            }
            
            // 7. Survival check
            if (equityValue < 0) {
                if (dieYear === null) dieYear = year;
                equityValue = 0;
                equityPrincipal = 0;
            }
            
            const totalWealth = equityValue + bondValue;
            
            data.push({
                year,
                equity: Math.max(0, equityValue),
                bond: Math.max(0, bondValue),
                totalWealth: Math.max(0, totalWealth),
                livingCost: livingCostThisYear,
                phase: 'retirement'
            });
            
            if (totalWealth <= 0) break;
            
            // 8. Apply annual market returns
            const eqReturn = returnsSequence[returnIndex++];
            equityValue *= (1 + eqReturn);
            bondValue *= (1 + currentBondReturn);
            
            // 9. Inflation already applied in step 1 for next iteration
        }
    }

    if (retireYear === null && targetMode === 'year') {
        retireYear = targetYear;
        const lastData = data[data.length - 1];
        retTarget = lastData ? lastData.totalWealth : 0;
        const yearsFromNow = retireYear - startYear;
        lcAtRetire = livingCostToday * Math.pow(1 + inflation, yearsFromNow);
    }

    return {
        data,
        retireYear,
        dieYear,
        retTarget,
        totalInvested,
        lcAtRetire
    };
}

/* â”€â”€â”€ Render Simulation Summary â”€â”€â”€ */
function renderSimulationSummary(simResults, startYear) {
    const summaryContainer = document.getElementById('summaryStatsContainer');
    const summarySection = document.getElementById('simulationSummary');
    const summaryTitle = summarySection.querySelector('h3');
    const zh = currentLang === 'zh';
    
    // Update title with actual simulation count
    const simCount = simResults.length;
    summaryTitle.innerHTML = `
        <span class="lang-en" style="display:${zh?'none':'inline'}">${simCount} Simulations Summary</span>
        <span class="lang-zh" style="display:${zh?'inline':'none'}">${simCount}æ¬¡æ¨¡æ‹Ÿæ±‡æ€»</span>
    `;
    
    // Calculate statistics
    const retireYears = simResults.map(r => r.retireYear).filter(y => y !== null);
    const dieYears = simResults.map(r => r.dieYear).filter(y => y !== null);
    const retireWealths = simResults.map(r => r.retTarget).filter(w => w !== null && w !== undefined);
    
    const successRate = ((simResults.length - dieYears.length) / simResults.length * 100).toFixed(1);
    
    // For Target Amount mode: Find most common retirement year
    const retireYearCounts = {};
    retireYears.forEach(year => {
        retireYearCounts[year] = (retireYearCounts[year] || 0) + 1;
    });
    const mostCommonRetireYear = Object.keys(retireYearCounts).length > 0 
        ? Object.keys(retireYearCounts).reduce((a, b) => retireYearCounts[a] > retireYearCounts[b] ? a : b)
        : null;
    const mostCommonRetireYearCount = mostCommonRetireYear ? retireYearCounts[mostCommonRetireYear] : 0;
    
    // For Target Year mode: Find most common retirement wealth (grouped by 10000)
    const wealthGroups = {};
    retireWealths.forEach(wealth => {
        const group = Math.round(wealth / 10000) * 10000;
        wealthGroups[group] = (wealthGroups[group] || 0) + 1;
    });
    const mostCommonWealthGroup = Object.keys(wealthGroups).length > 0
        ? Object.keys(wealthGroups).reduce((a, b) => wealthGroups[a] > wealthGroups[b] ? a : b)
        : null;
    const mostCommonWealthCount = mostCommonWealthGroup ? wealthGroups[mostCommonWealthGroup] : 0;
    
    // Find most common starve year - use success rate to determine logic
    const starveYearCounts = {};
    dieYears.forEach(year => {
        starveYearCounts[year] = (starveYearCounts[year] || 0) + 1;
    });
    
    const didntStarveCount = simResults.length - dieYears.length;
    
    let mostCommonStarveYear = null;
    let mostCommonStarveYearCount = 0;
    let showDidntStarve = false;
    
    // New logic: use success rate threshold
    const successRateValue = parseFloat(successRate);
    
    if (successRateValue >= 80) {
        // Success rate >= 80%: show "No Starve"
        showDidntStarve = true;
    } else {
        // Success rate < 80%: show most common starve year
        if (dieYears.length > 0) {
            mostCommonStarveYear = Object.keys(starveYearCounts).reduce((a, b) => starveYearCounts[a] > starveYearCounts[b] ? a : b);
            mostCommonStarveYearCount = starveYearCounts[mostCommonStarveYear];
            showDidntStarve = false;
        } else {
            // Nobody starved (shouldn't happen if successRate < 80, but handle it)
            showDidntStarve = true;
        }
    }
    
    // Determine which statistic to show in second card based on target mode
    let secondCardHTML = '';
    if (targetMode === 'year') {
        secondCardHTML = `
            <div class="stat-card" style="padding:24px;">
                <div class="stat-label" style="font-size:0.95em; margin-bottom:12px;">
                    <span class="lang-en" style="display:${zh?'none':'block'}">Most Common Retire Wealth</span>
                    <span class="lang-zh" style="display:${zh?'block':'none'}">æœ€å¸¸è§é€€ä¼‘è´¢å¯Œ</span>
                </div>
                <div class="stat-value" style="font-size:2.2em; margin-bottom:8px;">${mostCommonWealthGroup ? '$' + fmt(mostCommonWealthGroup) : 'N/A'}</div>
                <div style="font-size:0.8em;color:var(--text-light);line-height:1.5;">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Occurred ${mostCommonWealthCount} times</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">å‡ºç°${mostCommonWealthCount}æ¬¡</span>
                </div>
            </div>
        `;
    } else {
        secondCardHTML = `
            <div class="stat-card" style="padding:24px;">
                <div class="stat-label" style="font-size:0.95em; margin-bottom:12px;">
                    <span class="lang-en" style="display:${zh?'none':'block'}">Most Common Retire Year</span>
                    <span class="lang-zh" style="display:${zh?'block':'none'}">æœ€å¸¸è§é€€ä¼‘å¹´ä»½</span>
                </div>
                <div class="stat-value" style="font-size:2.2em; margin-bottom:8px;">${mostCommonRetireYear || 'N/A'}</div>
                <div style="font-size:0.8em;color:var(--text-light);line-height:1.5;">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Occurred ${mostCommonRetireYearCount} times</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">å‡ºç°${mostCommonRetireYearCount}æ¬¡</span>
                </div>
            </div>
        `;
    }
    
    summaryContainer.innerHTML = `
        <div class="stat-card" style="background:linear-gradient(135deg,#27ae60,#229954); padding:24px;">
            <div class="stat-label" style="color:#fff;opacity:0.9; font-size:0.95em; margin-bottom:12px;">
                <span class="lang-en" style="display:${zh?'none':'block'}">Success Rate</span>
                <span class="lang-zh" style="display:${zh?'block':'none'}">æˆåŠŸç‡</span>
            </div>
            <div class="stat-value" style="color:#fff; font-size:2.2em; margin-bottom:8px;">${successRate}%</div>
            <div style="font-size:0.8em;color:#fff;opacity:0.85;line-height:1.5;">
                <span class="lang-en" style="display:${zh?'none':'inline'}">${simResults.length - dieYears.length} out of ${simResults.length} never starved</span>
                <span class="lang-zh" style="display:${zh?'inline':'none'}">${simResults.length}æ¬¡ä¸­${simResults.length - dieYears.length}æ¬¡æœªè€—å°½</span>
            </div>
        </div>
        
        ${secondCardHTML}
        
        <div class="stat-card ${dieYears.length > simResults.length * 0.5 ? 'danger' : ''}" style="padding:24px;">
            <div class="stat-label" style="font-size:0.95em; margin-bottom:12px;">
                <span class="lang-en" style="display:${zh?'none':'block'}">Most Stave Year</span>
                <span class="lang-zh" style="display:${zh?'block':'none'}">æœ€å¸¸è§ç»“æœ</span>
            </div>
            <div class="stat-value" style="font-size:2.2em; margin-bottom:8px;">
                ${showDidntStarve ? `
                    <span class="lang-en" style="display:${zh?'none':'inline'}">No Starve</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">æœªè€—å°½</span>
                ` : mostCommonStarveYear}
            </div>
            <div style="font-size:0.8em;color:var(--text-light);line-height:1.5;">
                ${showDidntStarve ? `
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Occurred ${didntStarveCount} times</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">å‡ºç°${didntStarveCount}æ¬¡</span>
                ` : `
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Starved ${mostCommonStarveYearCount} times<br>(${dieYears.length} total starved)</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">è€—å°½${mostCommonStarveYearCount}æ¬¡<br>ï¼ˆå…±${dieYears.length}æ¬¡è€—å°½ï¼‰</span>
                `}
            </div>
        </div>
    `;
    
    summarySection.style.display = 'block';
}

/* â”€â”€â”€ Render Results â”€â”€â”€ */
function renderResults(data, retireYear, dieYear, retTarget, totalInvested, lcAtRetire, startYear){
    const sc = document.getElementById('statsContainer');
    const retData = data.find(d=>d.year===retireYear);
    const zh = currentLang==='zh';
    const isLogScale = window.chartLogScale || false;

    if(retireYear && retData){
        const gains = retData.totalWealth - totalInvested;
        sc.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Retirement Target</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">é€€ä¼‘ç›®æ ‡èµ„äº§</span>
                </div>
                <div class="stat-value">$${fmt(retTarget)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Living Cost at Retire</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">é€€ä¼‘æ—¶å¹´ç”Ÿæ´»æˆæœ¬</span>
                </div>
                <div class="stat-value">$${fmt(lcAtRetire)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Total Invested</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">ç´¯è®¡æŠ•å…¥</span>
                </div>
                <div class="stat-value">$${fmt(totalInvested)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Gains at Retire</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">é€€ä¼‘æ—¶æŠ•èµ„æ”¶ç›Š</span>
                </div>
                <div class="stat-value">$${fmt(gains)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Retirement Year</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">é€€ä¼‘å¹´ä»½</span>
                </div>
                <div class="stat-value">${retireYear}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Years to Retire</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">è·ç¦»é€€ä¼‘å¹´æ•°</span>
                </div>
                <div class="stat-value">${retireYear-startYear}</div>
            </div>
            <div class="stat-card ${dieYear?'danger':''}">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Starve Year</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">èµ„é‡‘è€—å°½å¹´ä»½</span>
                </div>
                <div class="stat-value">${dieYear||'âˆ'}</div>
            </div>
            <div class="stat-card ${dieYear?'danger':''}">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Survive After Retire</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">é€€ä¼‘åå­˜æ´»å¹´æ•°</span>
                </div>
                <div class="stat-value">${dieYear?(dieYear-retireYear):'âˆ'}</div>
            </div>`;
    } else {
        sc.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Status</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">çŠ¶æ€</span>
                </div>
                <div class="stat-value" style="font-size:1.15em">
                    <span class="lang-en" style="display:${zh?'none':'inline'}">Target Not Reached</span>
                    <span class="lang-zh" style="display:${zh?'inline':'none'}">æœªè¾¾åˆ°é€€ä¼‘ç›®æ ‡</span>
                </div>
            </div>`;
    }

    // Chart
    if(chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('wealthChart').getContext('2d');

    const years  = data.map(d=>d.year);
    const twArr  = data.map(d=>d.totalWealth);
    const eqArr  = data.map(d=>d.equity);
    const bdArr  = data.map(d=>d.bond);
    const lcArr  = data.map(d=>d.livingCost);
    
    // For logarithmic scale, replace 0 with 1 to avoid discontinuity
    const eqArrLog = isLogScale ? eqArr.map(v => v === 0 ? 1 : v) : eqArr;
    const bdArrLog = isLogScale ? bdArr.map(v => v === 0 ? 1 : v) : bdArr;
    const lcArrLog = isLogScale ? lcArr.map(v => v === 0 ? 1 : v) : lcArr;
    
    // Check if max equity exceeds 10x retirement target
    const maxEquity = Math.max(...eqArr);
    let yAxisConfig = {};
    
    if (!isLogScale) {
        // Normal scale: Y from 0 to 2 * retirement target
        if (retTarget) {
            yAxisConfig = {
                min: 0,
                max: retTarget * 2
            };
        } else {
            yAxisConfig = { min: 0 };
        }
    }

    const annotations = {};
    if(retireYear){
        annotations.retireLine = {
            type:'line',
            xMin: years.indexOf(retireYear), xMax: years.indexOf(retireYear),
            borderColor:'#27ae60', borderWidth:2.5, borderDash:[6,4],
            label:{
                display:true,
                content: currentLang==='en' ? `Retire: ${retireYear}` : `é€€ä¼‘: ${retireYear}å¹´`,
                position:'start',
                backgroundColor:'rgba(39,174,96,0.85)', color:'#fff',
                font:{size:11}
            }
        };
    }
    if(dieYear){
        annotations.dieLine = {
            type:'line',
            xMin: years.indexOf(dieYear), xMax: years.indexOf(dieYear),
            borderColor:'#e74c3c', borderWidth:2.5, borderDash:[6,4],
            label:{
                display:true,
                content: currentLang==='en' ? `Money Out: ${dieYear}` : `è€—å°½: ${dieYear}å¹´`,
                position:'end',
                backgroundColor:'rgba(231,76,60,0.85)', color:'#fff',
                font:{size:11}
            }
        };
    }



    chartInstance = new Chart(ctx, {
        type:'line',
        data:{
            labels: years,
            datasets:[
                { label: currentLang==='en'?'Equity':'è‚¡ç¥¨',
                  data:eqArrLog, borderColor:'#2980b9',
                  borderWidth:3, fill:false, tension:.3, pointRadius:0, pointHoverRadius:5 },
                { label: currentLang==='en'?'Bond':'å€ºåˆ¸',
                  data:bdArrLog, borderColor:'#27ae60',
                  borderWidth:2, fill:false, tension:.3, pointRadius:0, pointHoverRadius:5 },
                { label: currentLang==='en'?'Living Cost':'ç”Ÿæ´»æˆæœ¬',
                  data:lcArrLog, borderColor:'#e74c3c', borderDash:[5,5],
                  borderWidth:2, fill:false, tension:.3, pointRadius:0, pointHoverRadius:5 }
            ]
        },
        options:{
            responsive:true, maintainAspectRatio:false,
            interaction:{ intersect:false, mode:'index' },
            plugins:{
                legend:{ display:true, position:'top',
                    labels:{ font:{size:12,family:'IBM Plex Sans'}, padding:12, usePointStyle:true, boxWidth:8 }
                },
                tooltip:{
                    backgroundColor:'rgba(26,35,50,0.95)', padding:12,
                    titleFont:{size:13,family:'IBM Plex Sans'},
                    bodyFont:{size:12,family:'IBM Plex Sans'},
                    callbacks:{ label: c => (c.dataset.label||'')+': $'+fmt(c.parsed.y) }
                },
                annotation:{ annotations }
            },
            scales:{
                x:{ grid:{color:'rgba(0,0,0,0.05)'}, ticks:{font:{size:10,family:'IBM Plex Sans'}} },
                y:{ 
                    type: isLogScale ? 'logarithmic' : 'linear',
                    grid:{color:'rgba(0,0,0,0.05)'},
                    ticks:{ callback: v=>'$'+fmt(v), font:{size:10,family:'IBM Plex Sans'} },
                    ...yAxisConfig
                }
            }
        }
    });
}

/* â”€â”€â”€ Helpers â”€â”€â”€ */
function fmt(n){ return Math.round(n).toLocaleString('en-US'); }

function toggleLanguage(){
    currentLang = currentLang==='zh' ? 'en' : 'zh';
    document.querySelectorAll('.lang-en').forEach(e=> e.style.display = currentLang==='en'?'inline':'none');
    document.querySelectorAll('.lang-zh').forEach(e=> e.style.display = currentLang==='zh'?'inline':'none');

    if(chartInstance){
        chartInstance.data.datasets[0].label = currentLang==='en'?'Equity':'è‚¡ç¥¨';
        chartInstance.data.datasets[1].label = currentLang==='en'?'Bond':'å€ºåˆ¸';
        chartInstance.data.datasets[2].label = currentLang==='en'?'Living Cost':'ç”Ÿæ´»æˆæœ¬';
        chartInstance.update();
    }
}
</script>
</body>
</html>
